### 14.1.1 Rの場合

```{r}
library(tidyverse)

my_data <- data.frame(
  language = c(  0, 20, 20, 25, 22, 17),
  english  = c(  0, 20, 40, 20, 24, 18),
  math     = c(100, 20,  5, 30, 17, 25),
  science  = c(  0, 20,  5, 25, 16, 23),
  society  = c(  0, 20, 30,  0, 21, 17),
  row.names = c("A", "B", "C", "D", "E", "F"))
```

```{r}
my_result <- my_data %>% prcomp # 主成分分析

my_result$x # 主成分スコア
#>          PC1        PC2        PC3         PC4           PC5
#> A -74.907282  -7.010808 -0.3614994  0.07634299  2.855324e-15
#> B  13.818842   2.753459  5.2730387  0.84184215 -2.251702e-15
#> C  33.714034 -18.417290 -4.8762936 -0.88204193  1.189989e-15
#> D   1.730630  17.876372 -7.9250760 -0.14931705  1.907888e-16
#> E  17.837474  -1.064998  1.6526759  2.31254121 -3.195391e-15
#> F   7.806303   5.863266  6.2371544 -2.19936737 -3.088116e-16
```

```{r}
summary(my_result) # 累積寄与率
#> Importance of components:
#>                            PC1      PC2     PC3     PC4       PC5
#> Standard deviation     38.2644 12.25566 5.58845 1.52970 1.232e-15
#> Proportion of Variance  0.8885  0.09115 0.01895 0.00142 0.000e+00
#> Cumulative Proportion   0.8885  0.97963 0.99858 1.00000 1.000e+00
```

```{r}
my_result$rotation # 主成分の係数ベクトル
#>                 PC1         PC2         PC3          PC4       PC5
#> language  0.2074983  0.27946267 -0.30611747  0.764942594 0.4472136
#> english   0.3043604 -0.32505207 -0.61579860 -0.471696908 0.4472136
#> math     -0.8872612 -0.09764267 -0.05634538 -0.007654992 0.4472136
#> science   0.1301984  0.70266673  0.33844622 -0.418045446 0.4472136
#> society   0.2452041 -0.55943466  0.63981523  0.132454751 0.4472136
```

```{r}
my_result %>% biplot(scale = 0) # バイプロット
# あるいは
my_result %>% ggbiplot::ggbiplot(labels = row.names(my_data), scale = 0)
# 結果は図14.1に掲載済み
```

### 14.1.3 標準化＋主成分分析

```{r}
my_result <- my_data %>% scale %>% prcomp
# あるいは
my_result <- my_data %>% prcomp(scale = TRUE)

my_result$x # 主成分スコア
#>          PC1        PC2         PC3         PC4           PC5
#> A -3.6737215 -0.5688501 -0.05844947  0.01063636  1.666052e-16
#> B  0.6528793  0.2469258  0.43479807  0.09304529 -1.473852e-16
#> C  1.5682936 -1.7425981 -0.38057121 -0.09773435 -2.378048e-16
#> D  0.2505043  1.6400394 -0.67536551 -0.03199130  4.441609e-16
#> E  0.8861864 -0.1104931  0.09254037  0.23037874  6.742923e-18
#> F  0.3158579  0.5349762  0.58704775 -0.20433475 -2.435092e-16
```

### 14.1.4 補足：行列計算による再現

```{r}
library(tidyverse)
my_data <- data.frame(
  language = c(  0, 20, 20, 25, 22, 17),
  english  = c(  0, 20, 40, 20, 24, 18),
  math     = c(100, 20,  5, 30, 17, 25),
  science  = c(  0, 20,  5, 25, 16, 23),
  society  = c(  0, 20, 30,  0, 21, 17),
  row.names = c("A", "B", "C", "D", "E", "F"))

Z <- my_data %>% scale(scale = FALSE) %>% as.matrix # 標準化しない場合
# Z <- my_data %>% scale %>% as.matrix              # 標準化する場合

S <- var(Z)       # 分散共分散行列
tmp <- eigen(S)   # 固有値と固有ベクトル
Z %*% tmp$vectors # 主成分スコア
#>         [,1]       [,2]       [,3]        [,4]          [,5]
#> A  74.907282  -7.010808  0.3614994  0.07634299  4.631681e-15
#> B -13.818842   2.753459 -5.2730387  0.84184215 -8.024862e-15
#> C -33.714034 -18.417290  4.8762936 -0.88204193  6.963149e-15
#> D  -1.730630  17.876372  7.9250760 -0.14931705  2.855324e-15
#> E -17.837474  -1.064998 -1.6526759  2.31254121 -1.007877e-14
#> F  -7.806303   5.863266 -6.2371544 -2.19936737  1.911634e-15

cumsum(tmp$values) / sum(tmp$values) # 累積寄与率
#> [1] 0.8884833 0.9796285 0.9985801 1.0000000 1.0000000
```

```{r}
A <- svd(Z)                                # 特異値分解
all.equal(Z, A$u %*% diag(A$d) %*% t(A$v), # 元に戻ることの確認
          check.attributes = FALSE)
#> [1] TRUE

Z %*% A$v # 主成分スコアは先とほぼ同じになる（結果は割愛）

e <- A$d^2 / nrow(my_data) # 分散共分散行列の固有値
cumsum(e) / sum(e)         # 累積寄与率
#> [1] 0.8884833 0.9796285 0.9985801 1.0000000 1.0000000
```

